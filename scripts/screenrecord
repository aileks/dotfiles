#!/bin/bash

# Screen recording utility for river/Wayland
# Usage: screenrecord [area|window|fullscreen]
# Toggle-based: first call starts, second call stops

set -uo pipefail

PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:$PATH"

MODE="${1:-area}"
RECORDING_DIR="$HOME/Videos/recordings"
PIDFILE="/tmp/screenrecord.pid"
FILENAME="recording-$(date +%Y%m%d-%H%M%S).mp4"

notify() {
  local title="$1"
  local message="$2"
  local urgency="${3:-normal}"

  if command -v notify-send >/dev/null 2>&1; then
    notify-send -a screenrecord -u "$urgency" "$title" "$message"
  else
    printf '%s\n' "$title: $message" >&2
  fi
}

require_bin() {
  if ! command -v "$1" >/dev/null 2>&1; then
    notify "Recording error" "Missing dependency: $1"
    exit 1
  fi
}

require_bin wf-recorder
require_bin slurp

# Check if already recording
if [[ -f $PIDFILE ]]; then
  PID=$(cat "$PIDFILE")
  if kill -0 "$PID" 2>/dev/null; then
    kill -SIGINT "$PID"
    rm -f "$PIDFILE"
    notify "Recording stopped" "Saved to $RECORDING_DIR"
    exit 0
  else
    rm -f "$PIDFILE"
  fi
fi

mkdir -p "$RECORDING_DIR"

select_region() {
  slurp
}

fullscreen_region() {
  require_bin wlr-randr
  require_bin jq

  wlr-randr --json | jq -r '
    map(select(.enabled)) as $outs
    | if ($outs | length) == 0 then empty else
      $outs
      | map(
          . as $o
          | ($o.modes[] | select(.current)) as $m
          | ($o.scale // 1) as $s
          | ($o.transform // "normal" | tostring) as $t
          | ($m.width) as $w
          | ($m.height) as $h
          | (if ($t | test("90|270")) then $h else $w end) as $tw
          | (if ($t | test("90|270")) then $w else $h end) as $th
          | {x: $o.position.x, y: $o.position.y, w: ($tw / $s), h: ($th / $s)}
        )
      | {minx: (map(.x) | min), miny: (map(.y) | min),
         maxx: (map(.x + .w) | max), maxy: (map(.y + .h) | max)}
      | {x: (.minx | floor), y: (.miny | floor),
         w: ((.maxx | ceil) - (.minx | floor)),
         h: ((.maxy | ceil) - (.miny | floor))}
      | "\(.x),\(.y) \(.w)x\(.h)"
    end
  '
}

case "$MODE" in
  area | window)
    region=$(select_region || true)
    if [[ -z ${region} ]]; then
      notify "Recording cancelled" "No region selected"
      exit 1
    fi
    wf-recorder -g "$region" -f "$RECORDING_DIR/$FILENAME" &
    ;;
  fullscreen)
    region=$(fullscreen_region || true)
    if [[ -z ${region} ]]; then
      notify "Recording error" "No fullscreen region found"
      exit 1
    fi
    wf-recorder -g "$region" -f "$RECORDING_DIR/$FILENAME" &
    ;;
  *)
    echo "Usage: screenrecord [area|window|fullscreen]"
    exit 1
    ;;
esac

echo $! >"$PIDFILE"
notify "Recording started" "Mode: $MODE"
