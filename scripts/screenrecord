#!/bin/bash

# Screen recording utility for river/Wayland
# Usage: screenrecord [area|window|fullscreen]
# Toggle-based: first call starts, second call stops

set -uo pipefail

MODE="${1:-area}"
RECORDING_DIR="$HOME/Videos/recordings"
PIDFILE="/tmp/screenrecord.pid"
FILENAME="recording-$(date +%Y%m%d-%H%M%S).mp4"

notify() {
  notify-send "$1" "$2"
}

# Check if already recording
if [[ -f $PIDFILE ]]; then
  PID=$(cat "$PIDFILE")
  if kill -0 "$PID" 2>/dev/null; then
    kill -SIGINT "$PID"
    rm -f "$PIDFILE"
    notify "Recording stopped" "Saved to $RECORDING_DIR"
    exit 0
  else
    rm -f "$PIDFILE"
  fi
fi

mkdir -p "$RECORDING_DIR"

select_region() {
  slurp
}

case "$MODE" in
  area|window)
    region=$(select_region || true)
    if [[ -z ${region} ]]; then
      notify "Recording cancelled" "No region selected"
      exit 1
    fi
    wf-recorder -g "$region" -f "$RECORDING_DIR/$FILENAME" &
    ;;
  fullscreen)
    wf-recorder -f "$RECORDING_DIR/$FILENAME" &
    ;;
  *)
    echo "Usage: screenrecord [area|window|fullscreen]"
    exit 1
    ;;
esac

echo $! >"$PIDFILE"
notify "Recording started" "Mode: $MODE"
