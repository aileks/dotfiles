#!/bin/bash
# Statusbar module: network status
# Left click: open network connections
# Middle click: show network details notification
# Right click: toggle wifi

set -euo pipefail

notify() {
  notify-send "󰈀 Network" "$1"
}

active_connection() {
  nmcli -t -f NAME,TYPE connection show --active 2>/dev/null | grep -E 'wireless|wifi|ethernet' | head -1
}

case "${1:-}" in
  --open)
    nm-connection-editor >/dev/null 2>&1 &
    disown $!
    exit 0
    ;;
  --info)
    connection=$(active_connection)
    if [[ -n $connection ]]; then
      name=${connection%%:*}
      notify "Connected: $name"
    else
      notify "No active connection"
    fi
    exit 0
    ;;
  --toggle-wifi)
    if nmcli -t -f wifi radio | grep -q "enabled"; then
      nmcli radio wifi off
      notify "WiFi Disabled"
    else
      nmcli radio wifi on
      notify "WiFi Enabled"
    fi
    pkill -RTMIN+4 waybar
    exit 0
    ;;
esac

connection=$(active_connection)
if [[ -z $connection ]]; then
  printf '{"text":"󰤭","class":"network disconnected"}\n'
  exit 0
fi

name=${connection%%:*}
type=${connection##*:}

if [[ $type == "802-11-wireless" ]]; then
  signal=$(nmcli -t -f IN-USE,SIGNAL dev wifi 2>/dev/null | awk -F: '$1=="*" {print $2; exit}')
  icon="󰤥"
  class="warning"
  if [[ -n $signal ]]; then
    if [[ $signal -ge 70 ]]; then
      icon="󰤨"
      class="good"
    elif [[ $signal -ge 40 ]]; then
      icon="󰤥"
      class="normal"
    else
      icon="󰤟"
      class="warning"
    fi
  fi
  text="$icon WiFi"
  tooltip="$name (${signal:-?}%)"
else
  text="󰈀 Eth"
  tooltip="$name"
  class="good"
fi

printf '{"text":"%s","tooltip":"%s","class":"network %s"}\n' "$text" "$tooltip" "$class"
