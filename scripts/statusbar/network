#!/bin/bash
# Statusbar module: network status
# Left click: open nmtui
# Middle click: show network details notification
# Right click: toggle wifi

set -euo pipefail

notify() {
  notify-send "󰈀 Network" "$1"
}

active_connection() {
  local connections
  connections=$(nmcli -t -f NAME,TYPE connection show --active 2>/dev/null || true)
  printf '%s\n' "$connections" | awk -F: '$2 ~ /(wireless|wifi|ethernet)/ {print; exit}'
}

case "${1:-}" in
  --open)
    if ! command -v nmtui >/dev/null 2>&1; then
      notify "nmtui not found"
      exit 1
    fi
    wezterm start --class network-floating -- nmtui >/dev/null 2>&1 &
    disown $!
    exit 0
    ;;
  --info)
    connection=$(active_connection)
    if [[ -n $connection ]]; then
      name=${connection%%:*}
      notify "Connected: $name"
    else
      notify "No active connection"
    fi
    exit 0
    ;;
  --toggle-wifi)
    if nmcli -t -f wifi radio | grep -q "enabled"; then
      nmcli radio wifi off
      notify "WiFi Disabled"
    else
      nmcli radio wifi on
      notify "WiFi Enabled"
    fi
    pkill -RTMIN+4 waybar
    exit 0
    ;;
esac

connection=$(active_connection)
if [[ -z $connection ]]; then
  wifi_state=$(nmcli -t -f WIFI radio 2>/dev/null || true)
  if [[ $wifi_state == "disabled" ]]; then
    printf '{"text":"󰤮 WiFi","tooltip":"WiFi disabled","class":"network disconnected"}\n'
  else
    printf '{"text":"󰤭 WiFi","tooltip":"WiFi disconnected","class":"network disconnected"}\n'
  fi
  exit 0
fi

name=${connection%%:*}
type=${connection##*:}

if [[ $type == "802-11-wireless" ]]; then
  signal=$(nmcli -t -f IN-USE,SIGNAL dev wifi 2>/dev/null | awk -F: '$1=="*" {print $2; exit}' || true)
  icon="󰤥"
  class="warning"
  if [[ -n $signal ]]; then
    if [[ $signal -ge 70 ]]; then
      icon="󰤨"
      class="good"
    elif [[ $signal -ge 40 ]]; then
      icon="󰤥"
      class="normal"
    else
      icon="󰤟"
      class="warning"
    fi
  fi
  text="$icon WiFi"
  tooltip="$name (${signal:-?}%)"
else
  text="󰈀 Eth"
  tooltip="$name"
  class="good"
fi

printf '{"text":"%s","tooltip":"%s","class":"network %s"}\n' "$text" "$tooltip" "$class"
