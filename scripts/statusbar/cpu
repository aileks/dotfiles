#!/bin/bash
# Statusbar module: CPU usage
# Left click: show CPU details notification
# Right click: open btop

set -euo pipefail

cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/waybar"
cache_file="$cache_dir/cpu"

read_cpu() {
  local _cpu user nice system idle iowait irq softirq steal guest guest_nice
  read -r _cpu user nice system idle iowait irq softirq steal guest guest_nice </proc/stat
  local idle_all=$((idle + iowait))
  local non_idle=$((user + nice + system + irq + softirq + steal))
  local total=$((idle_all + non_idle))
  printf '%s %s\n' "$total" "$idle_all"
}

calc_cpu_usage() {
  local total_now idle_now total_prev idle_prev total_diff idle_diff usage

  read -r total_now idle_now < <(read_cpu)
  if [[ -f "$cache_file" ]]; then
    read -r total_prev idle_prev <"$cache_file"  || true
  else
    total_prev=""
  fi

  if [[ -z "${total_prev:-}" ]]; then
    sleep 0.2
    read -r total_prev idle_prev < <(read_cpu)
    total_diff=$((total_prev - total_now))
    idle_diff=$((idle_prev - idle_now))
    printf '%s %s\n' "$total_prev" "$idle_prev" >"$cache_file"
  else
    total_diff=$((total_now - total_prev))
    idle_diff=$((idle_now - idle_prev))
    printf '%s %s\n' "$total_now" "$idle_now" >"$cache_file"
  fi

  if ((total_diff <= 0)); then
    usage=0
  else
    usage=$(((100 * (total_diff - idle_diff)) / total_diff))
  fi

  if ((usage < 0)); then
    usage=0
  elif ((usage > 100)); then
    usage=100
  fi

  printf '%s\n' "$usage"
}

notify_cpu() {
  local cpu
  mkdir -p "$cache_dir"
  cpu=$(calc_cpu_usage)
  notify-send "󰻠 CPU Usage" "Current CPU: ${cpu}%"
}

open_btop() {
  wezterm start --class btop-floating -- btop >/dev/null 2>&1 &
  disown $!
}

case "${1:-}" in
  --notify)
    notify_cpu
    exit 0
    ;;
  --open)
    open_btop
    exit 0
    ;;
esac

mkdir -p "$cache_dir"
cpu=$(calc_cpu_usage)
load=$(awk '{print $1" "$2" "$3}' /proc/loadavg)

class="normal"
if [[ $cpu -ge 80 ]]; then
  class="critical"
elif [[ $cpu -ge 50 ]]; then
  class="warning"
fi

tooltip="CPU: ${cpu}%\\nLoad: ${load}"
printf '{"text":"󰻠 %s%%","class":"cpu %s","tooltip":"%s"}\n' "$cpu" "$class" "$tooltip"
