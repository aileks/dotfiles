#!/bin/bash
# Statusbar module: CPU usage
# Left click: show CPU details notification
# Right click: open btop

set -euo pipefail

notify_cpu() {
  local cpu
  cpu=$(top -bn1 | awk -F'[, ]+' '/Cpu\(s\)/ {print int($3 + $5)}')
  notify-send "󰻠 CPU Usage" "Current CPU: ${cpu}%"
}

open_btop() {
  wezterm start --class btop-floating -- btop >/dev/null 2>&1 &
  disown $!
}

case "${1:-}" in
  --notify)
    notify_cpu
    exit 0
    ;;
  --open)
    open_btop
    exit 0
    ;;
esac

cpu=$(top -bn1 | awk -F'[, ]+' '/Cpu\(s\)/ {print int($3 + $5)}')
load=$(awk '{print $1" "$2" "$3}' /proc/loadavg)

class="normal"
if [[ $cpu -ge 80 ]]; then
  class="critical"
elif [[ $cpu -ge 50 ]]; then
  class="warning"
fi

tooltip="CPU: ${cpu}%\\nLoad: ${load}"
printf '{"text":"󰻠 %s%%","class":"cpu %s","tooltip":"%s"}\n' "$cpu" "$class" "$tooltip"
