#!/bin/bash
# Statusbar module: memory usage
# Left click: show memory details notification
# Right click: open btop

set -euo pipefail

notify_mem() {
  local mem swap
  mem=$(free -h | awk '/Mem:/ {print $3 "/" $2}')
  swap=$(free -h | awk '/Swap:/ {print $3 "/" $2}')
  notify-send "󰍛 Memory Usage" "RAM: $mem\nSwap: $swap"
}

open_btop() {
  wezterm start --class btop-floating -- btop >/dev/null 2>&1 &
  disown $!
}

case "${1:-}" in
  --notify)
    notify_mem
    exit 0
    ;;
  --open)
    open_btop
    exit 0
    ;;
esac

mem=$(free | awk '/Mem:/ {printf "%.0f", $3/$2 * 100}')
read -r mem_used mem_total < <(free -h | awk '/Mem:/ {print $3, $2}')
read -r swap_used swap_total < <(free -h | awk '/Swap:/ {print $3, $2}')

class="normal"
if [[ $mem -ge 80 ]]; then
  class="critical"
elif [[ $mem -ge 50 ]]; then
  class="warning"
fi

tooltip="RAM: ${mem_used}/${mem_total} (${mem}%)\\nSwap: ${swap_used}/${swap_total}"
printf '{"text":"󰍛 %s%%","class":"memory %s","tooltip":"%s"}\n' "$mem" "$class" "$tooltip"
