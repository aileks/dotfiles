#!/bin/bash
# Statusbar module: clock/date
# Left click: toggle between time/date
# Right click: launch calcurse

set -euo pipefail

state_file="/tmp/waybar_clock_state"

ensure_state() {
  if [[ ! -f $state_file ]]; then
    echo "time" >"$state_file"
  fi
}

do_toggle() {
  ensure_state
  current_state=$(cat "$state_file")
  if [[ $current_state == "time" ]]; then
    echo "date" >"$state_file"
  else
    echo "time" >"$state_file"
  fi
  pkill -RTMIN+6 waybar
}

do_open() {
  wezterm start --class calendar-floating -- calcurse >/dev/null 2>&1 &
  disown $!
}

case "${1:-}" in
  --toggle)
    do_toggle
    exit 0
    ;;
  --open)
    do_open
    exit 0
    ;;
esac

ensure_state

icon="ó°ƒ°"
date_fmt="%a %b %d"
time_fmt="%H:%M"

date_str=$(date +"$date_fmt")
time_str=$(date +"$time_fmt")

current_state=$(cat "$state_file")
if [[ $current_state == "time" ]]; then
  text="$icon $time_str"
  tooltip="$date_str"
else
  text="$icon $date_str"
  tooltip="$time_str"
fi

printf '{"text":"%s","tooltip":"%s","class":"clock"}\n' "$text" "$tooltip"
