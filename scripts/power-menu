#!/bin/bash

set -euo pipefail

PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:$PATH"

FUZZEL_BIN="${FUZZEL_BIN:-fuzzel}"
FUZZEL_ARGS="${FUZZEL_ARGS:-}"

cmd_exists() {
  command -v "$1" >/dev/null 2>&1
}

die() {
  printf '%s\n' "$1" >&2
  exit 1
}

fuzzel_dmenu() {
  local prompt="$1"

  if ! cmd_exists "$FUZZEL_BIN"; then
    die "fuzzel not found"
  fi

  "$FUZZEL_BIN" --dmenu --prompt "$prompt" ${FUZZEL_ARGS:-}
}

confirm() {
  local action="$1"

  local choice
  choice=$(printf 'No\nYes\n' | fuzzel_dmenu "Confirm ${action}?")
  [[ $choice == "Yes" ]]
}

do_lock() {
  if cmd_exists lock; then
    exec lock
  fi

  if cmd_exists waylock; then
    exec waylock
  fi

  if cmd_exists loginctl; then
    if [[ -n ${XDG_SESSION_ID:-} ]]; then
      exec loginctl lock-session "$XDG_SESSION_ID"
    fi
    exec loginctl lock-sessions
  fi

  die "No lock backend found (waylock/loginctl)"
}

do_logout() {
  if cmd_exists niri; then
    if niri msg action quit >/dev/null 2>&1; then
      exit 0
    fi
  fi

  if cmd_exists loginctl && [[ -n ${XDG_SESSION_ID:-} ]]; then
    exec loginctl terminate-session "$XDG_SESSION_ID"
  fi

  die "No logout backend found"
}

do_reboot() {
  if cmd_exists systemctl; then
    exec systemctl reboot
  fi

  if cmd_exists loginctl; then
    exec loginctl reboot
  fi

  if cmd_exists reboot; then
    exec reboot
  fi

  die "No reboot backend found"
}

do_suspend() {
  if cmd_exists systemctl; then
    exec systemctl suspend
  fi

  if cmd_exists loginctl; then
    exec loginctl suspend
  fi

  die "No suspend backend found"
}

do_shutdown() {
  if cmd_exists systemctl; then
    exec systemctl poweroff
  fi

  if cmd_exists loginctl; then
    exec loginctl poweroff
  fi

  if cmd_exists shutdown; then
    exec shutdown -h now
  fi

  if cmd_exists poweroff; then
    exec poweroff
  fi

  die "No shutdown backend found"
}

LOCK=$'\uf023  Lock'
LOGOUT=$'\uf2f5  Logout'
REBOOT=$'\uf2f1  Reboot'
SUSPEND=$'\uf186  Suspend'
SHUTDOWN=$'\uf011  Shutdown'

choice=$(printf '%s\n%s\n%s\n%s\n%s\n' "$LOCK" "$LOGOUT" "$REBOOT" "$SUSPEND" "$SHUTDOWN" | fuzzel_dmenu 'Power')

case "$choice" in
  "$LOCK")
    do_lock
    ;;
  "$LOGOUT")
    confirm "logout" && do_logout
    ;;
  "$REBOOT")
    confirm "reboot" && do_reboot
    ;;
  "$SUSPEND")
    confirm "suspend" && do_suspend
    ;;
  "$SHUTDOWN")
    confirm "shutdown" && do_shutdown
    ;;
  "")
    exit 0
    ;;
  *)
    exit 0
    ;;
esac
